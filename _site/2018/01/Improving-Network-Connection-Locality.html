<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link rel="stylesheet" href="/assets/css/normalize.css"/>
  <link rel="stylesheet" href="/assets/css/bulma.css"/>
  <link rel="stylesheet" href="/assets/css/custom.css"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet"> -->

  <!-- Icons -->
  <link rel="shortcut icon" href="/assets/images/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <title>
    
      Improving Network Connection Locality on Multicore Systems &middot; Columba M71's Blog
    
  </title>

</head>


<body>

<section class="hero is-dark">
  <div class="hero-body">
    <div class="container">
        <h1 class="title">
          <span class="typewrite" data-period="2000" data-type='[ "Columba M71"]'>
            <span class="wrap"></span>
          </span>
        </h1>
      <h4 class="subtitle" id="quote">
      </h4>
    </div>
  </div>
</section>

<div class="main-container">
  <div class="tile is-ancestor is-vertical">


    <nav class="nav has-shadow">

      <div class="nav-left">

        <a href="/" class="nav-item">
          <span class="icon">
            <i class="fa fa-home" aria-hidden="true" title="Homepage"></i>
          </span>
        </a>

        <a href="https://github.com/hnu2013wwj" class="nav-item">
          <span class="icon">
            <i class="fa fa-github" aria-hidden="true" title="Github"></i>
          </span>
        </a>

        <div class="nav-item" id="searchFieldNav">
          <div class="field has-addons">
            <p class="control">
              <input class="input is-small" type="text" placeholder="Find an article" id="search-text">
            </p>
            <p class="control">
              <a class="button is-dark is-small" onclick="searchHandler();">
                Search
              </a>
            </p>
          </div>
        </div>

      </div>

      <div class="nav-right nav-menu" id='nav-menu'>
        <a href="/archive" class="nav-item">Archive</a>
        <a href="/tags" class="nav-item">Tags</a>
      </div>

      <span class="nav-toggle" id="nav-toggle">
          <span></span>
          <span></span>
          <span></span>
    </nav>

    <div class="tile is-parent">
      <div class="tile is-8 is-child main">

        <div class="box">
    <h1 class="post-title">Improving Network Connection Locality on Multicore Systems</h1>
    <hr/>
    <div class="content"><span class="post-text"><h2 id="improving-network-connection-locality-on-multicore-systems">Improving Network Connection Locality on Multicore Systems</h2>

<h3 id="引言">引言</h3>

<p>这个是最近三篇关于Linux 内核网络栈优化文章中的第1篇，后面的两篇会之后加上[2,3]。这篇文章解决Linux中Connection Locality的问题的。提出了一个叫做MegaPipe办法。</p>

<p>问题:  这以幅图就基本说明了目前存在的问题。多个核心共享一些结构导致了冲突的问题。</p>

<p><img src="/assets/img/conn-local-listen.png" alt="conn-local-listen" /></p>

<h3 id="基本思路">基本思路</h3>

<p>基本思路就是将这些共享的结构弄成非共享的。Affinity-Accept 将这些结构变成了每一个核心一份。</p>

<p>第一个要解决的问题就是包路由的问题，这里需要将来自一个连接的包有交给同一个核心。这里通过网卡的功能解决。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The NIC hardware typically hashes each packet’s flow identifier five-tuple (the protocol number, source and destination IP addresses, and source and destination port numbers) and uses the resulting hash value to look up the RX DMA ring where the packet will be placed. Since all packets from a single connection will have the same flow hash values, the NIC will deliver all packets from a single connection into a single DMA ring.
</code></pre></div></div>

<p>Accept Affinity每个core一个accept queue，应用线程优先在本地的core上的accept queue来处理连接。一个应用线程调用accept的时候，它返回本地的accpet queue上面的已经处理好的连接，如果本地没有，那就将这个线程睡眠。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>When new connections arrive, the network stack wakes up any threads waiting on the local core’s accept queue. This allows all connection processing to occur locally.
</code></pre></div></div>

<h3 id="负载均衡">负载均衡</h3>

<p>上面的分区的方式可能导致的一个问题就是负载不均衡的问题。这里的负载不均衡分为两类：</p>

<p>这里就不具体讨论细节了。</p>

<ul>
  <li>
    <p>short-term imbalance，可能是一些突发的原因导致的，这里使用的解决方式就是connection stealing，类似于work steaing的功能。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Affinity-Accept’s connection stealing mechanism consists of two parts: the first is the mechanism for stealing a connection from another core, and the second is the logic for determining when stealing should be done, and determining the core from which the connection should be stolen.
</code></pre></div>    </div>
  </li>
  <li>
    <p>longer-term load imbalance，可能是不均衡的分配导致的，这里的解决方式是 flow group migration 方式解决。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>each non-busy core finds the victim core from which it has stolen the largest number of connections, and migrates one flow group from that core to itself (by reprogramming the NIC’s FDir table). In our configuration (4,096 flow groups and 48 cores), stealing one flow group every 100ms was sufficient. Busy cores do not migrate additional flow groups to themselves.
</code></pre></div>    </div>
  </li>
</ul>

<p>.</p>

<h3 id="评估">评估</h3>

<p><img src="/assets/img/conn-local-evolution.png" alt="conn-local-evolution" /></p>

<p>.</p>

<h2 id="参考">参考</h2>

<ol>
  <li>Improving Network Connection Locality on Multicore Systems, EuroSys’12.</li>
  <li>MegaPipe: A New Programming Interface for Scalable Network I/O, OSDI 2012.</li>
  <li>Scalable Kernel TCP Design and Implementation for Short-Lived Connections, ASPLOS ’16.</li>
</ol>

</span></div>
</div>


      </div>

      <div class="tile is-4 is-child">
        <div class="tile is-parent is-vertical sidebar">

          <div class="tile is-child widget">

            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Recent Posts
                </p>
              </header>
              <div class="card-content">
                <div class="content nice-text">
                  <ul>
                  
                  <li><a href="/2018/10/LegoOS.html">
                    LegoOS -- A Disseminated, Distributed OS for Hardware Resource Disaggregation
                  </a></li>
                  
                  <li><a href="/2018/10/Level-Hashing.html">
                    Write-Optimized and High-Performance Hashing Index Scheme for Persistent Memory
                  </a></li>
                  
                  <li><a href="/2018/10/Classical-Papers.html">
                    计算机科学经典论文
                  </a></li>
                  
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="tile is-child widget">

            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Sponsored
                </p>
              </header>
              <div class="card-content">
                <div class="content nice-text">
                  <img src="/assets/images/Dust_Bunny.jpg"/>
                </div>
              </div>
            </div>

          </div>

          <div class="tile is-child widget">
            <div class="card">
              <header class="card-header">
                <p class="card-header-title nice-title">
                  Recommended Websites
                </p>
              </header>
              <!-- <div class="card-content">
                <div class="content nice-text">
                  <ul>
                    <li>
                      <a href="https://xkcd.com">xkcd</a>
                    </li>
                    <li>
                      <a href="http://commitstrip.com">Commit Strip</a>
                    </li>
                    <li>
                      <a href="http://www.smbc-comics.com">SMBC Comics</a>
                    </li>
                    <li>
                      <a href="https://blog.codinghorror.com">Coding Horror</a>
                    </li>
                    <li>
                      <a href="http://waitbutwhy.com">Wait Buy Why</a>
                    </li>
                    <li>
                      <a href="https://simplysoch.wordpress.com/">Simply Soch</a>
                    </li>
                  </ul>
                </div> -->
              </div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>
</div>

<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p>
        Some rights reserved.
      </p>
      <p>
        Made with <i class="fa fa-heart"></i> and <a href="https://github.com/jgthms/bulma">Bulma</a>, <a href="https://jekyllrb.com/">Jekyll</a>. Hosted on <a href="https://github.com/">Github</a>
      </p>
      <p>
        <a class="icon" href="">
          <i class="fa fa-github" title="Github"></i>
        </a>
        <a class="icon" href="">
          <i class="fa fa-linkedin" title="Linkedin"></i>
        </a>
        <a class="icon" href="">
          <i class="fa fa-envelope" title="Email"></i>
        </a>
      </p>
    </div>
  </div>
</footer>

<!-- js -->
<script src="/assets/js/custom.js"></script>
<script src="/assets/js/typewriter.js"></script>
</body>
</html>
