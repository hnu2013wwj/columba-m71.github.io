---
layout: page
title: Distributed — 全局状态与快照
tags: [Distributed]
excerpt_separator: <!--more-->
typora-root-url: ../
---

# Distributed — 全局状态与快照

  在没有共享存储器和全局时钟的分布式系统之中有效的纪录系统的全局状态很重要但也不是一件简单的事情。系统全局状态在死锁检测，故障恢复等方面都有很重要的作用。
  分布式系统的全局状态是进程和通道本地状态的集合，使用符号GS表示[1]。
  分布式系统中的一致性快照需要处理一下的两个问题:
    1. 如何判别纪录在快照中的消息和没有在快照中的消息，要求:
        0x01. 在纪录快照之前的一个进程发送的消息一定都会被记录在全局快照之中；
           0x02. 在纪录快照之后的一个进程发送的消息一定都不会被记录在全局快照之中。
    2. 如何确定快照的瞬间。



这里只讲了一些很基础的东西。



## FIFO通道: Chandy - Lamport 算法

  Chandy - Lamport 算法算法假设通信的通道是FIFO的和可靠的，它使用了一个称为标记的控制信息。算法主要由两个部分组成: 标记发送规则和标记接收规则。消息一个进程在记录完它自己的快照之后，向其它所有的进程发送一个标记，这个被称为标记发送规则。因为通信通道是FIFO的，使用标记将在快照之前的消息标示出来，这样可以满足上面的第1点。
  一个进程在接受到来自一个通道C标记之后，如果它还没有记录自身的状态，则记录接受到标记的通道C的状态为空，并执行上面描述的的标记发送规则。如果已经接受到C的标记，则记录C的状态记录为在该通道上记录了本地状态之后且在接受标记之前的消息的集合。

 算法的过程如下[1，2]:
	1. 进程p的标记发送规则:
	  0x01 进程p记录本地状态；
	  0x02 对其它进程发送标记。
	2. 进程p的标记接收规则:
	  进程p在通道C接收到标记后，如何p没有记录自身的状态，则记录C的状态为空并执行标记发送规则，
	  否则，记录C的状态为消息集。
	算法在进程p接收到来自所有输入通道的标记之后终止。
	



### Variants

以Chandy - Lamport算法为基础，再次之上有多种算法的变种。
 Spezialetti - Kearns 算法主要在快照收集的并发启动和被记录快照的有效发送。
 在一些系统之中，会定期的收集系统的全局快照，Venkatesan快照增量算法优化了这种情况，Venkatesan快照增量算法将上一次获取的快照和记录最后一次快照以来的增量快照结合在一起，形成目前的系统快照。



### 应用

  Flink中的创建快照的算法[4]主要收到了Chandy - Lamport算法的启发。在Flink中，为了容错，使用了Checkpoint的机制，在错误发生之后恢复错误时，可以恢复到获取的某个Checkpoint，对于具体细节的描述，可以参考Flink的相关资料和论文[4]。



## 非FIFO通道

  在FIFO的通道中，Chandy - Lamport 算法的标记很好的区分了快照之前的消息和快照之后的消息。但是在非FIFO的通道之中，这种办法就想不通了。
  为了实现和Chandy - Lamport 算法区分消息的效果，Lai - Yang算法使用了着色的方法，方法如下:
    每个进程开始的时候是白色的，拍快照的时候变成了红色，对应的白色的(红色的)消息就是拍快照前(后）发送的消息；每个白色进程在合适的时刻拍下自己的快照，这个时刻不应该晚与接收到一个红色消息的瞬间。



## 参考

1. ​《分布式计算 -- 原理、算法与系统》，ISBN: 978-7-04-032456-3
2. https://en.wikipedia.org/wiki/Chandy-Lamport_algorithm
3. Apache Flink: https://flink.apache.org
4. Lightweight Asynchronous Snapshots for Distributed Dataflows: https://arxiv.org/abs/1506.08603
